<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../services/get-access-token.html">
<link rel="import" href="../services/redux-store.html">

<dom-module id="get-user-info">
    <template>
        <style>
            :host{
            }
        </style>

        <api-request
                headers="[[ ajax.headers ]]"
                method="[[ ajax.method ]]"
                endpoint="[[ ajax.endpoint ]]"
                response="{{ apiResponse }}"></api-request>
    </template>
    <script>
        Polymer({
            is: 'get-user-info',
            properties: {
                accessToken: {
                    type: String
                },
                session: {
                    type: Object,
                    statePath: 'session'
                },
                apiResponse: {
                    type: Object,
                    reflectToAttribute: false,
                    notify: true,
                    observer: '_apiResponseChanged'
                },
                userId: {
                    value: String,
                    //For only downward Data Flow
                    notify: false,
                    readOnly: false,
                    observer: '_userIdChanged'
                },
                mail: {
                    type: String,
                    //For only Upward Data Flow
                    notify: true,
                    readOnly: true
                },
                name: {
                    type: String,
                    //For only Upward Data Flow
                    notify: true,
                    readOnly: true
                }
            },
            behaviors: [
                    ReduxBehavior
            ],
            ready: function() {
                /*this.ajax = {
                    headers: {
                        Authorization: this.session.accessToken
                    },
                    method: 'GET',
                    endpoint: '/platformusers/' + this.userId
                }*/
            },

            _userIdChanged: function (userId) {
                console.debug('[get-user-info.html] userIdChanged: ', userId);
                console.log(this.session);
                var at = "";

                if (this.accessToken && this.accessToken != "") {
                    console.log("Chose this.accessToken");
                    at = this.accessToken;
                } else if (this.session) {
                    console.log("Chose session object");
                    at = this.session.accessToken;
                }
                console.debug('[get-user-info.html] also I know this accessToken: ', at);
                this.ajax = {
                    headers: {
                        Authorization: at
                    },
                    method: 'GET',
                    endpoint: '/platformusers/' + userId
                };
            },

            //Function for setting Mail & Name on Ajax response
            _apiResponseChanged: function(response) {

                if (response.type == 'response') {
                    this._setMail(response.data.email);
                    this._setName(response.data['first_name'] + " " + response.data.name);
                }
            }
        });
    </script>
</dom-module>