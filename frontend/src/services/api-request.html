<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module is="api-request">

    <template>

        <iron-ajax auto
                   body="[[ body ]]"
                   content-type="[[ contentType ]]"
                   handle-as="json"
                   headers="[[ headers ]]"
                   loading="{{ loading }}"
                   method="[[ method ]]"
                   on-error="_handleError"
                   on-response="_handleResponse"
                   url="[[ url ]]"
                   verbose></iron-ajax>

    </template>

    <script>

        Polymer({

            is: 'api-request',

            properties: {
                accessToken: {
                    type: String
                },

                baseUrl: {
                    type: String,
                    reflectToAttribute: false,
                    value: 'http://localhost:3000/api'
//                    value: 'https://lmu-mt-api.herokuapp.com/api'
                },

                body: {
                    type: Object,
                    value: {}
                },

                contentType: {
                    type: String,
                    value: 'application/json'
                },

                endpoint: {
                    type: String,
                    observer: '_computeUrl'
                },

                headers: {
                    type: Object,
                    value: {}
                },

                loading: {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                method: {
                    type: String,
                    value: 'GET'
                },

                response: {
                    type: Object,
                    notify: true,
                    value: ''
                },

                url: {
                    type: String,
                    reflectToAttribute: false
                }
            },

            ready: function () {
                var cookieAccessToken = this._getCookie('mt-api-accesstoken');
                this.headers.Authorization = cookieAccessToken;
            },

            _handleResponse: function (response) {
                this.response = {
                    data: response.detail.response,
                    type: 'response'
                };
            },

            _handleError: function (response) {
                this.response = {
                    data: response.detail.error,
                    type: 'error'
                };
                console.log("# error #")
                console.log(response)
            },

            _computeUrl: function () {
                this.url = this.baseUrl + this.endpoint;
            },

            _getCookie: function (cookieName) {

                var name = cookieName + '=';
                var allCookies = document.cookie.split(';');
                var idx;
                for (idx in allCookies) {
                    var cookie = allCookies[idx];
                    while (cookie.charAt(0) == ' ') {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(name) == 0) {
                        return cookie.substring(name.length, cookie.length);
                    }
                }
                return '';
            }
        });

    </script>

</dom-module>