<!--
The Main View manages:
• Sub-Routing between Dashboard and Detail Pages
• Data exchange between Sub-Views
• Global functions for logged-in users
(• Notifications )
The Main View contains:
• Sub-Routing
• Menu Bar
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../components/index-card.html">
<link rel="import" href="../components/group-card.html">
<link rel="import" href="../components/group-detail.html">
<link rel="import" href="../components/groups-admin.html">
<link rel="import" href="../components/notifications-card.html">
<link rel="import" href="../components/navigation-bar.html">
<link rel="import" href="../components/admin-toolbar.html">
<link rel="import" href="semester-setup-view.html">
<link rel="import" href="admin-dashboard.html">
<link rel="import" href="tutor-dashboard.html">
<link rel="import" href="student-dashboard.html">

<link rel="import" href="../shared/shared-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/effects/resize-snapped-title.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/effects/fade-background.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/transburger-icon/transburger-icon.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">

<dom-module id="main-view">

    <template>

        <style include="shared-styles">
            :host {
                width: 100%;
                height: auto;
            }

            .desktop-only{
                display: none;
            }

            /*Phone*/
            @media screen and (max-width: 767px) {

                admin-toolbar {
                    margin: 0;
                }
            }

            /*Tablet*/
            @media screen and (min-width: 768px) and (max-width: 1023px) {
                .group-container {
                    margin: 10px;
                    width: calc(50% - 20px);
                }

                .practicals-container {
                    margin: 10px;
                    width: calc(50% - 20px);
                }
            }

            /*Desktop*/
            @media screen and (min-width: 1024px) {
                .no-desktop{
                    display: none;
                }
                .desktop-only{
                    display: block;
                }

                .menu-icon:hover {
                    background-color: var(--paper-blue-grey-500);
                }
                .menu-icon {
                    background-color: transparent !important;
                }
            }

            .nav-container {
                border-bottom: var(--paper-blue-grey-700) solid 1px;
                background: var(--paper-blue-grey-600);
                height: 70px;
            }

            .configuration {
                float: left;
            }

            .notification {
                float: right;
            }

            iron-collapse{
                z-index: 20;
            }

            .icon {
                display: block;
                margin: auto;
                /*padding-top: 10px;*/
                width: 100px;
                z-index: 1;
            }

            paper-icon-button {
                /*position: relative;*/
                margin: 5%;
                color: var(--paper-blue-grey-900);
            }

            .notification a {
                text-decoration: none;
            }

            .notification paper-button {
                background: none;
                min-width: 0;
                margin: 0;
                padding: 0;
                color: var(--paper-blue-grey-900);
            }

            /*.notification paper-button:hover, paper-icon-button:hover {
                color: var(--paper-blue-grey-500);
                -o-transition: .1s;
                -moz-transition: .1s;
                -webkit-transition: .1s;
                transition: .1s;
            }*/

            .active-language {
                text-decoration: underline !important;
            }

            .left-triangle {
                z-index: 20;
                fill: #546E7A;
                height: 30px;
                width: calc(50% - 20px);
                position: absolute;
                top: 70px;
                left: 0;
                float: left;
                stroke: #455A64;
                stroke-width: 5;
            }

            .rect {
                z-index: 20;
                fill: #546E7A;
                height: 30px;
                width: 45px;
                position: absolute;
                left: calc(50% - 25px);
                top: 70px;

            }

            .right-triangle {
                z-index: 20;
                fill: #546E7A;
                height: 30px;
                width: calc(50% - 15px);
                position: absolute;
                top: 70px;
                right: 0;
                float: left;
                stroke: #455A64;
                stroke-width: 5;
            }

            .icon-one {
                left: calc(50% - 52px);
                /* top: 0; */
                height: 100%;
                z-index: 100;
                text-align: center;
                width: 100px;
                position: relative;
            }

            .icon-one > img {
                height: 100%;
            }

            .helper_container {
                height: auto;
            }

            paper-toolbar.tall {
                height: 100px;
            }

            paper-toolbar {
                height: 60px;
                font-size: 16px;
                line-height: 60px;
                padding: 0 10px;
                color: white;
                transition: height 0.2s;
                z-index: 20;
            }

            .icon-container {
                position: absolute;
                background-color: var(--paper-blue-grey-600);
                width: 100%;
                height: 60px;
                top: 0;
                left: 0;

            }

            .larger_geometry_container {

                z-index: 20;
                height: 0;
                opacity: 0;
                transition: height,opacity 0.2s;

            }

            .larger_geometry_container > div {
                z-index: 20;
                background-color: var(--paper-blue-grey-600);
                height: 10px;
                width: 100%;
                position: absolute;
                top: 60px;
                left: 0;
            }

            paper-toolbar.tall > .larger_geometry_container {
                height: 10px;
                opacity: 1;
                transition: height,opacity 0.2s;

            }

            #menu {
                background-color: var(--paper-blue-grey-800);
                height: 80px;
                /*border-bottom: 10px solid var(--paper-blue-grey-500);*/
                width: auto;
                margin: 0 auto;
            }

            paper-icon-button {
                color: var(--paper-blue-grey-50);

            }
            .menu-icon{

                background-color: var(--paper-blue-grey-500);
                border-radius: 50%;
                height: 40px;
                width: 40px;
                margin: 12px;
            }
            
            .menu-icon-wrapper{
                float: right;
            }
            .menu-icon-container{
                top: 8px;
                position: relative;
                left: calc(50% - 96px);
                width: 192px;
                height: 64px;
                background-color: var(--paper-blue-grey-200);
                border-radius: 32px;
            }


            /*#notifications{
                position: fixed;
                z-index: 10;
                top: 60px;
            }*/
            
            /*.not-active{
                /*display: none !important;
                opacity: 0;
                height: 0px !important;*/
                /*background-color: red;
                transition: background-color 2s;*/
            /*}*/
            .menu-overlay{

                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                position: fixed;
                z-index: 10;
                top: 80px;

                opacity: 1;
                display: block;
                transition: opacity 0.2s;
            }
            .menu-overlay.not-active{
                opacity: 0;
                height: 0;
                transition: opacity 0.2s, height 0.2s ease 0.1s;

            }
            
            button{
                color: var(--paper-blue-grey-50);
                background-color: transparent;
                --transburger-icon-line-radius: 0;
                border-radius: 50%;
            }
            button:focus{
                outline: none;
                border: none;
            }
            button:hover{
                color: var(--paper-blue-grey-100);
            }

            .hidden{
                visibility: hidden;
                display: none;
            }
        </style>

        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"
                tail="{{subRoute}}"></app-route>

        <div style="height: 100vh; width: 100%; overflow: hidden; min-width: 320px;">

            <iron-collapse id="menu" class="no-desktop">
                <div class="menu-icon-container">

                    <div class="menu-icon-wrapper"> <!--class="configuration nav-block"-->
                        <paper-icon-button class="menu-icon" icon="icons:exit-to-app" on-tap="_fireLogoutRequest"></paper-icon-button>
                        <paper-tooltip>Logout</paper-tooltip>
                    </div>

                    <div class="menu-icon-wrapper"> <!--class="configuration nav-block"-->
                        <paper-icon-button class="menu-icon" icon="icons:settings" on-tap="_fireLogoutRequest"></paper-icon-button>
                        <paper-tooltip>Logout</paper-tooltip>
                    </div>

                    <div class="menu-icon-wrapper"> <!--class="configuration nav-block"-->
                        <paper-icon-button class="menu-icon" icon="icons:language" on-tap="_fireLogoutRequest"></paper-icon-button>
                        <paper-tooltip>Logout</paper-tooltip>

                    </div>

                    <!--div> class="notification  nav-block">
                        <paper-button on-click="initSwitchLocale">{{ language }}</paper-button>
                        <paper-tooltip offset="5">{{localize('logincard_locale button tooltip')}}</paper-tooltip>
                    </div-->
                </div>

            </iron-collapse>
            <paper-header-panel mode="waterfall-tall">
                <paper-toolbar>
                    <div class="icon-one nav-block">
                        <img src="../../images/mt.svg">
                    </div>

                    <div class="icon-container">

                        <div class="configuration nav-block no-desktop" id="menuButton">
                            <button id="transburger" is="transburger-icon" no-transform transform-to="{{transburgerChangeTo}}" on-tap="_toggleMenu" style=""></button>
                            <paper-tooltip>Menu</paper-tooltip>
                        </div>
                        <!--div class="configuration nav-block no-desktop" id="menuButton">
                            <paper-icon-button icon="menu" on-tap="_toggleMenu" style=""></paper-icon-button>
                            <paper-tooltip>Menu</paper-tooltip>
                        </div>
                        <div class="configuration nav-block no-desktop hidden" id="backButton">
                            <paper-icon-button icon="menu" on-tap="_goBack" style=""></paper-icon-button>
                            <paper-tooltip>Menu</paper-tooltip>
                        </div-->


                        <div class="notification  nav-block no-desktop">
                            <paper-icon-button class="mobile-and-tablet-only" icon="social:notifications"
                                               on-tap="_toggleNotifications"></paper-icon-button>
                        </div>

                        <paper-menu-button>
                            <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
                            <div class="dropdown-content"> Test Notification Content </div>
                            </paper-menu-button>
                            <!--paper-menu class="dropdown-content">
                                <paper-item>Share</paper-item>
                                <paper-item>Settings</paper-item>
                                <paper-item>Help</paper-item>
                            </paper-menu>
                        </paper-menu-button-->

                        <div class="menu-icon-wrapper desktop-only"> <!--class="configuration nav-block"-->
                            <paper-icon-button class="menu-icon" icon="icons:settings" on-tap="_fireLogoutRequest"></paper-icon-button>
                            <paper-tooltip>Logout</paper-tooltip>

                        </div>
                        <div class="menu-icon-wrapper desktop-only"> <!--class="configuration nav-block"-->
                            <paper-icon-button class="menu-icon" icon="icons:language" on-tap="_fireLogoutRequest"></paper-icon-button>
                            <paper-tooltip>Logout</paper-tooltip>

                        </div>
                        <div class="menu-icon-wrapper desktop-only"> <!--class="configuration nav-block"-->
                            <paper-icon-button class="menu-icon" icon="icons:exit-to-app" on-tap="_fireLogoutRequest"></paper-icon-button>
                            <paper-tooltip>Logout</paper-tooltip>
                        </div>



                            <!--div> class="notification  nav-block">
                                <paper-button on-click="initSwitchLocale">{{ language }}</paper-button>
                                <paper-tooltip offset="5">{{localize('logincard_locale button tooltip')}}</paper-tooltip>
                            </div-->
                    </div>
                    <div>
                        <iron-collapse id="notifications">
                            <div style="height: 300px; width: 100%; background-color:green;">Test Notification Container</div>
                        </iron-collapse>
                    </div>

                    <div class="larger_geometry_container">
                        <div></div>
                        <svg viewBox="0 0 200 200" class="left-triangle" preserveAspectRatio="none">
                            <polygon points="0,0 200,0 200,200 "></polygon>
                        </svg>
                        <svg viewBox="0 0 200 200" class="right-triangle" preserveAspectRatio="none">
                            <polygon points="200,0 0,200 0,0 "></polygon>
                        </svg>
                        <svg viewBox="0 0 200 200" class="rect" preserveAspectRatio="none">
                            <rect width="200" height="200"></rect>
                        </svg>
                    </div>

                    <iron-collapse id="notifications_2">
                        <div style="height: 300px; width: 100%; background-color:green;">Test Notification Container</div>
                    </iron-collapse>

                </paper-toolbar>
                <div>

                    <div class="menu-overlay not-active" on-tap="_toggleMenu"></div>
                    <!--template is="dom-if" if="{{ showMobileNotifications }}">
                        <notifications-card showlist="{{ showMobileNotifications }}"></notifications-card>
                    </template-->

                    <!-- P A G E S -->
                    <iron-pages
                            selected="[[routeData.page]]"
                            attr-for-selected="name"
                            fallback-selection="error">

                        <!-- Dashboard Page -->
                        <div class="main-page" name="dashboard">
                            <template is="dom-if" if="{{user.isAdmin}}">
                                <admin-dashboard
                                        user="{{user}}"
                                        access-token="[[accessToken]]"></admin-dashboard>
                            </template>
                            <template is="dom-if" if="{{user.isTutor}}">
                                <tutor-dashboard
                                        user="{{user}}"
                                        access-token="[[accessToken]]"></tutor-dashboard>
                            </template>
                            <template is="dom-if" if="{{user.isStudent}}">
                                <student-dashboard
                                        user="{{user}}"
                                        access-token="[[accessToken]]"></student-dashboard>
                            </template>
                        </div>

                        <!-- Practical Detail Pages -->
                        <practicals-view
                                name="photo"
                                type="Foto"
                                icon="[[icon]]"
                                route="{{subRoute}}"
                                on-back-click="_handleBackTap"
                                access-token="[[ accessToken ]]"
                                user-id="{{ user.id }}"></practicals-view>
                        <practicals-view
                                name="video"
                                type="Video"
                                icon="[[icon]]"
                                route="{{subRoute}}"
                                on-back-click="_handleBackTap"
                                access-token="[[ accessToken ]]"
                                user-id="{{ user.id }}"></practicals-view>
                        <practicals-view
                                name="audio"
                                type="Audio"
                                icon="[[icon]]"
                                route="{{subRoute}}"
                                on-back-click="_handleBackTap"
                                access-token="[[ accessToken ]]"
                                user-id="{{ user.id }}"></practicals-view>

                        <!-- Semester Setup Pages (Admin only) -->
                        <template is="dom-if" if="[[ user.isAdmin ]]">
                            <semester-setup-view
                                    name="semester-setup"
                                    page="{{ page }}"
                                    access-token="[[ accessToken ]]"></semester-setup-view>
                            <groups-admin
                                    name="groups"
                                    access-token="[[ accessToken ]]"
                                    self-info="{{user}}"
                                    selected-semester="[[ adminSelectedSemesterId ]]"></groups-admin>
                        </template>

                    </iron-pages>


                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>
                    <div>Scroll Content</div>

                </div>
            </paper-header-panel>
        </div>

        <!--Iron Signal Fired on Logout-->
        <iron-signals on-iron-signal-forget="_forget"></iron-signals>
    </template>


    <script>
        Polymer({

            is: 'main-view',

            properties: {

                transburgerChangeTo: {
                    type: String
                },

                accessToken: {
                    type: String,
                    observer: '_accessTokenChanged'
                },
                adminSelectedSemesterId: {
                    //TODO try iron meta
                    type: String
                },
                group: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                user: {
                    type: Object,
                    observer: '_userChanged'
                    /*notify: true,
                    readOnly: false,
                    value: {}*/
                },
                route: {
                    type: Object,
                    notify: true,
                    observer: '_routeChanged'
                },
                routeData: {
                    type: Object,
                    observer: '_routeDataChanged'
                },
                language: {
                    type: String,
                    value: 'de'
                },
                activeIcon: String
            },

            behaviors: [
                Polymer.AppLocalizeBehavior
            ],


            attached: function () {
                <!--TODO import locales globally -->
                this.loadResources(this.resolveUrl('../shared/locales.json'));
            },

            ready: function () {

            },

            observers: [
                //'_routePageChanged(routeData.page)'
            ],
            listeners: {
                'CHANGE_ROUTE' : '_handleRouting',
                'icon-changed' : '_handleIconChanged'
            },

            _handleIconChanged: function (event) {
                this.set('activeIcon',event.detail.icon);
                console.log('icon changed to: '+event.detail.icon);
                console.log(this.$$('#menu').opened);
                if(event.detail.icon=='close' && this.$$('#menu').opened){
                    //this.$.transburger.toggleIcon();
                }else if(event.detail.icon=='menu' && this.$$('#menu').opened){
                    //this.$.transburger.toggleIcon();
                }
            },
            isStudent: function () {
                if (!this.user.isAdmin && !this.user.isTutor) {
                    return true;
                }
            },

            _switchLocale: function () {
                this.language = (this.language == 'en') ? 'de' : 'en';
            },
            _toggleMenu: function (detail) {

                if(this.routeData.page!='dashboard'){
                    window.history.back();
                    this.set('transburgerChangeTo','close');
                    this.$.transburger.toggleIcon();

                }else{
                    console.log(detail);

                    this.$.transburger.toggleIcon();
                    this.$$('#menu').toggle();
                    //console.log(this.$$('.menu-overlay'));
                    //this.$$('.menu-overlay').toggleAttribute()
                    //this.toggleClass('is-active',Polymer.dom(this.$$('.menu-overlay')));
                    this.updateStyles();
                    this.$$('.menu-overlay').classList.toggle('not-active');
                    console.log(this.$.menu.opened);
                    console.log(this.$.transburger.icon);
                    if(this.$.menu.opened && this.activeIcon=='menu'){
                        this.$.transburger.toggleIcon();

                    }
                    //.toggleAttribute('is-active', true);
                }
            },
            _toggleNotifications: function () {
                this.$$('#notifications').toggle();
            },

            _routeChanged: function (detail) {
                console.log(detail);
                if(detail.prefix=='/main' && detail.path==''){
                    this.set('route.path','/dashboard');
                    this.set('routeData.page','dashboard');


                }

                //Change scroll position -> 0 (on routeChanged)
                this.$$('paper-header-panel').scroller.scrollTop = 0;
            },

            _routeDataChanged: function (detail) {
                console.log(detail);

                if(detail.page==='dashboard'){
                    console.log("Dashboard!");
                    //this.$.transburger.toggleIcon();
                    //console.log(this.$.transburger);

                    this.set('transburgerChangeTo','close');
                }/*else{
                    console.log("Not Dashboard!");
                    this.set('transburgerChangeTo','arrow-left');
                    this.$.transburger.toggleIcon();

                }*/

            },
            _userChanged: function (detail) {
                console.log("User Changed in Main View: ");
                console.log(detail);
                if (!this.user.isAdmin && !this.user.isTutor) {
                    this.set('user.isStudent', true);
                }
                console.log(this.user);
            },

            _fireLogoutRequest: function () {
                this._toggleMenu();
                this.fire('USER_LOGOUT');
            },

            /**
             * Callback fired on logout to reset all data.
             * @private
             */
            _forget: function () {
                console.log('Heard Forget Event');
                //TODO reset all data
            },

            /**
             * Event listener hearing CHANGE_ROUTE to route for child components.
             * @private
             */
            _handleRouting: function (event) {
                this.set('route.path',event.detail.path);
                this.set('routeData.page',event.detail.page);
                //TODO change menu icon to back button

                this.set('transburgerChangeTo','arrow-left');
                this.$.transburger.toggleIcon();


                //Change scroll position -> 0 (on routeChanged)
                this.$$('paper-header-panel').scroller.scrollTop = 0;
                //this.toggleClass('hidden', this.$.menubutton);

                //Working
                //this.$.menuButton.classList.toggle('hidden');
                //this.$.backButton.classList.toggle('hidden');
                //Polymer.dom(this.root).querySelector('#menu-button').toggleClass('hidden');
                //this.toggleClass('hidden',this.$$('#menu-button'));

                //this.set('transburgerChangeTo','arrow-left');
                //this.$.transburger.toggleIcon();
                //this.$$('#back-button').toggleAttribute('hidden');
                //this.$$('#menu-button').toggleAttribute('hidden');
            },

            _accessTokenChanged: function (detail) {
                console.log("Access Token changed to: "+detail);
            }
        });
    </script>
</dom-module>
