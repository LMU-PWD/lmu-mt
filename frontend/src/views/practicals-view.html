<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared/shared-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../components/practicals-students-date-detail.html">

<!--Localization Imports-->
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../services/my-localize-behavior.html">


<dom-module id="practicals-view">
    <template>
        <style include="shared-styles">
            :host {
              #display: block;
            }
            .page{
              /*border-radius: 25px;*/
              margin: 24px;
              background-color: var(--paper-blue-grey-100);
              color: var(--paper-blue-grey-900);
            }
            .tabheader{
              background-color: var(--color);
              font-size: 18px;
              /*border-radius: 25px 25px 0px 0px;*/
              overflow: hidden;
              height: 40px;
            }
            .tabheaderbuttons{
              color: var(--paper-blue-grey-50);
              text-align: center;
            }
            .titles{
                text-align: center;
            }
            paper-tab{
              --paper-tab-ink:var(--paper-blue-grey-100);
              font-weight: 300;
            }
            paper-tab.iron-selected {
              color: var(--paper-blue-grey-900);
              background-color: var(--paper-blue-grey-100);
            }
            .icon{
              position: absolute;
                left: calc(50% - 24px);
                height: 40px;
                width: 40px;
              border-radius: 50%;
              background-color: var(--paper-blue-grey-100);
              border:  2px solid var(--paper-blue-grey-900);
              z-index: 1;
            }
            .content{
                padding: 10px;
                margin: 24px;
            }
        </style>

        <api-request
                headers="[[ ajax_labs.headers ]]"
                method="[[ ajax_labs.method ]]"
                endpoint="[[ ajax_labs.endpoint ]]"
                on-api-response="_handleAllLabsRequest"></api-request>


        <div class="page">
            <img class="icon" src="../../images/[[name]].svg" z-index="1">
            <paper-tabs selected="{{selectedTab}}" class="tabheader" no-slide>
                <paper-tab class="tabheaderbuttons">[[ localize('practicals-view tab_general') ]]</paper-tab>
                <paper-tab class="tabheaderbuttons">[[ localize('practicals-view tab_dates') ]]</paper-tab>
            </paper-tabs>
            <div class="content">
                <h1 class="titles">[[labType.type_str]] [[ localize('practicals-view title_practical') ]]</h1>
                <iron-pages selected="[[selectedTab]]">
                    <div>
                        <!--h1 class="titles">[[ localize('practicals-view title_information') ]]</h1-->
                        <template is="dom-if" if="[[user.isTutor]]">
                            <p>[[labType.description_tutor]]</p>
                        </template>
                        <template is="dom-if" if="[[user.isStudent]]">
                            <p>[[labType.description_student]]</p>
                        </template>
                    </div>
                    <div>
                        <!--h1 class="titles">[[ localize('practicals-view title_datepick') ]]</h1-->
                        <practicals-students-date-detail id="detailView"
                                                         group="{{ group }}"
                                                         user="{{ user }}"
                                                         lab-type="[[labType]]"
                                                         lab-data="[[labData]]"
                                                         all-labs="[[allLabs]]"
                                                         access-token="{{ accessToken }}"></practicals-students-date-detail>
                    </div>
                </iron-pages>
            </div>
        </div>

        <iron-signals on-iron-signal-language="changeLanguage"></iron-signals>

    </template>

    <script>
        Polymer({
            is: 'practicals-view',
            properties: {
                name: String,
                accessToken: {
                    type: String,
                    notify: true
                },
                practical_date:{
                    type: Date,
                    notify: true
                },
                route: {
                    type: Object,
                    notify: true
                },
                selectedTab:{
                    type: String,
                    value: "0"
                },
                type:{
                    type: String,
                    notify: true,
                    value: ""
                },
                isReady: {
                    type: Boolean,
                    value: false
                },
                user: {
                    type: Object,
                    observer: '_userChanged'
                },
                group: {
                    type: Object,
                    observer: '_groupChanged'
                },
                /*Paths:• Lab (final lab from group object)
                *       • Priorities (groups )    */
                labData: {
                    type: Object
                },

                /*Holding information about the labType (infotext, deadlines, ect.. )*/
                labType: {
                    type: Object,
                    observer: '_labTypeChanged'
                }
            },
            behaviors: [
                Polymer.MyLocalizeBehavior
            ],

            _groupChanged: function (detail) {
                var newLabData = {lab: {}, priorities: []};

                for (var i = 0; i < this.group.labIds.length; i++) {
                    //Matching groups labs id with lab id (map photo->photo ect.)
                    if (this.group.labIds[i].labTypeId == this.labType.id) {
                        newLabData.lab = this.group.labIds[i];
                    }
                }
                for (var i = 0; i < this.group.priorityIds.length; i++) {
                    //Matching groups labs id with lab id (map photo->photo ect.)
                    if (this.group.priorityIds[i].labTypeId == this.labType.id) {
                        newLabData.priorities.push(this.group.priorityIds[i]);
                    }
                }
                this.set('labData', newLabData);

                //Just for Testing
                //console.log(this.labType.type_str + ": Updated labData");
                //console.log(this.labData);

            },
            _userChanged: function (detail) {
//                console.log(detail);

                this.ajax_labs = {
                    headers: {
                        Authorization: this.accessToken,
                        filter: '{"where":{"semesterId":"'+this.user.semesterId+'","labTypeId":"'+this.labType.id+'"}}'
                    },
                    method: 'GET',
                    endpoint: '/Labs'
                };

            },
            _labTypeChanged: function (response) {
                //console.log(detail);
                this.customStyle['--color'] = this.labType.color;
                this.updateStyles();
            },
            _handleAllLabsRequest: function (response) {
                this.set('allLabs',response.detail);
                //console.log(this.allLabs);
            }
        });
    </script>
</dom-module>
