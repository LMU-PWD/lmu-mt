<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared/shared-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../components/practicals-date-selector.html">
<link rel="import" href="../components/practicals-no-registration-detail.html">
<link rel="import" href="../components/practicals-show-saved-dates.html">


<dom-module id="practicals-view">
  <template>
    <style include="shared-styles">
      :host {
        #display: block;
      }
      .page{
        #border-radius: 25px;
        margin: 24px;
        background-color: var(--paper-blue-grey-100);
        color: var(--paper-blue-grey-900);
      }
      .tabheader{
        background-color: var(--paper-blue-grey-900);
        font-size: 120%;
        #border-radius: 25px 25px 0px 0px;
        overflow: hidden;
        height: 5vh;
      }
      .tabheaderbuttons{
        color: var(--paper-blue-grey-50);
        text-align: center;
      }
      .backbutton{
        width: 70px;
        --paper-icon-button-ink-color:var(--paper-blue-grey-300);
        padding-right: 30px;
      }
      .firsttab{
        padding-left: 25px;
      }
      paper-tab{
        --paper-tab-ink:var(--paper-blue-grey-100);
        font-weight: 300;
      }
      paper-tab.iron-selected {
        color: var(--paper-blue-grey-900);
        background-color: var(--paper-blue-grey-100);
      }
      .icon{
        position: absolute;
        margin-left: 40px;
        margin-top: -5px;
        width: 64px;
        height: 64px;
        width: 6vh;
        height: 6vh;
        border-radius: 50%;
        background-color: var(--paper-blue-grey-100);
        border:  3px solid var(--paper-blue-grey-900);
        z-index: 1;
      }
      .content{
        padding: 10px;
      }
    </style>

    <div class="page">
      <img class="icon" src=[[icon]] z-index="1">
      <paper-tabs selected="{{selectedTab}}" class="tabheader" no-slide>
        <paper-icon-button  class="tabheaderbuttons backbutton" icon="icons:arrow-back" on-tap="_backClicked"></paper-icon-button>
        <paper-tab class="tabheaderbuttons firsttab">Allgemein</paper-tab>
        <paper-tab class="tabheaderbuttons">Termine</paper-tab>
      </paper-tabs>
      <div class="content">
        <h2>[[type]] Praktikum</h2>
        <iron-pages selected="[[selectedTab]]">
          <div>Page 1 Text</div>
          <div>
            <template is="dom-if" if="[[registration_open]]">
              <!-- Registration Open Bool from Api is true -->
              <template is="dom-if" if="[[!slots_already_chosen]]">
                <!-- Deadline is not over -->
                <practicals-date-selector id="practicalsDateSelector" type="[[type]]" practical_date="[[practical_date]]"
                                       timeslots="[[timeslots]]"
                                       on-save-click="_handleSaveClick"
                                       on-reset-click="_handleResetClick"></practicals-date-selector>
              </template>
              <template is="dom-if" if="[[slots_already_chosen]]">
                <!-- Deadline is over -->
                <practicals-show-saved-dates chosenslots="[[chosenslots]]" on-change-slots-click="_handleChangeClick"></practicals-show-saved-dates>
              </template>
            </template>
            <template is="dom-if" if="[[!registration_open]]">
              <!-- Registration Open Bool from Api is false -->
              <practicals-no-registration-detail practical_date="[[practical_date]]"
                                                 practical_date_string="[[practical_date_string]]"
                                                 before_deadline="[[before_deadline]]"></practicals-no-registration-detail>
            </template>
          </div>
        </iron-pages>
      </div>
    </div>
  </template>

  <script>
    Polymer({

        is: 'practicals-view',
        properties: {
            accessToken: {
                type: String,
                notify: true
            },
            before_deadline:{
                type: Boolean,
                value: true
            },
            chosenslots:{
                type: Array,
                value: []
            },
            icon:{
                type: String
            },
            practical_date:{
                type: Date,
                notify: true
            },
            registration_open:{
                type: Boolean,
                value: true
            },
            route: {
                type: Object,
                notify: true
            },
            slots_already_chosen:{
                type: Boolean,
                value: false
            },
            selectedTab:{
                type: String,
                value: "0"
            },
            timeslots:{
                type: Array,
                value: []
            },
            type:{
                type: String,
                notify: true,
                value: ""
            }
        },
        ready: function () {
            this.practical_date = this._getDate();
            this.timeslots = this._getTimeslots();
            //console.log(this.accessToken);
            //console.log(this.route);
        },
        /**
         * Back-button click handler
         */
        _backClicked: function(e) {
          this.type = "";
          this.fire("back-click");
          this._handleResetClick(e);
        },

        /**
         * Handle save click
         * @param e - Event Variable
         * @private
         */
        _handleSaveClick: function(e){
            var slotcounter = 0;
            for(i=0; i< e.target.chosenslots.length; i++){
                if(e.target.chosenslots[i] != null){
                    slotcounter++;
                }
            }
            if(slotcounter == e.target.chosenslots.length){
                this.chosenslots = [];
                this.chosenslots = e.target.chosenslots;
                this.slots_already_chosen = true;
            }
            else{
                console.log("Error: Not enogh slots chosen. Just "+slotcounter+" slots chosen.");
            }
        },
        /**
         * Handle reset click
         * @param e - Event Variable
         * @private
         */
        _handleResetClick: function(e){
            this.chosenslots = [];
        },
        /**
         * Handle change click
         * @param e - Event Variable
         * @private
         */
        _handleChangeClick: function(e){
            this.slots_already_chosen = false;
        },
        /**
         * Function that checks for the practial course date
         * @param {String} date - date that will be transformed to String
         */
        _getDate: function(){
            //TODO: Check for Practicalsdates in Backend
            //return null;
            return new Date(2017,2,25,14,0);
        },

        /**
         * Function that checks for the practial course date
         * @param {String} date - date that will be transformed to String
         */
        _getTimeslots: function(){
            //TODO: Get Timeslots from Backend
            var timeslots =[];
            timeslots.starttimes = [new Date(2017,1,2,1,0),new Date(2017,1,2,2,0),new Date(2017,1,2,3,0),new Date(2017,1,2,4,0),new Date(2017,1,2,5,0),
                new Date(2017,1,10,14,0),new Date(2017,1,10,15,0),new Date(2017,1,10,16,0),new Date(2017,1,10,17,0),new Date(2017,1,10,18,0),new Date(2017,1,10,19,0),new Date(2017,1,10,20,0),
                new Date(2017,1,12,12,0),new Date(2017,1,12,13,0),new Date(2017,1,12,14,0),new Date(2017,1,12,15,0),new Date(2017,1,14,14,0),new Date(2017,1,14,15,0)];
            timeslots.sizes =[60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60];

            return this._transformTimeslots(timeslots);
            //return null;
        },

        /**
         * Transform the Format of the given Timeslots from the Api, so it will be easier to handle in the frontend
         * @param slotsFromApi - Contains the given timeslots
         * @returns {Array} - timeslots in new format
         * @private
         */
        _transformTimeslots: function(slotsFromApi){
            var transformedSlots = []; //Store return-Array here
            var lastSlot = slotsFromApi.starttimes[0];
            var countDates = 0; //Date counter
            var countSlots = 0; //Slot counter
            var dates = [];

            for(i=0; i<slotsFromApi.starttimes.length; i++){
                // Create a new array-entrie if date from recent slot is different from date of the last slot
                if(slotsFromApi.starttimes[i].getFullYear() != lastSlot.getFullYear() ||
                    slotsFromApi.starttimes[i].getMonth() != lastSlot.getMonth() ||
                    slotsFromApi.starttimes[i].getDate() != lastSlot.getDate()) {
                    dates = [];
                    lastSlot = slotsFromApi.starttimes[i];
                    transformedSlots.push([]);
                    countDates++;
                    countSlots = 0;
                }
                var endtime = new Date(slotsFromApi.starttimes[i].getFullYear(), slotsFromApi.starttimes[i].getMonth(), slotsFromApi.starttimes[i].getDate());
                if((slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60)) > 60){
                    endtime.setHours(1+Math.floor(slotsFromApi.starttimes[i].getHours()+(slotsFromApi.sizes[i]) / 60));
                    endtime.setMinutes(slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60)-60);
                }
                else{
                    endtime.setHours(Math.floor(slotsFromApi.starttimes[i].getHours()+(slotsFromApi.sizes[i]) / 60));
                    endtime.setMinutes(slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60));
                }

                var slot = [];
                slot = [slotsFromApi.starttimes[i], endtime];
                dates[countSlots] = slot;
                transformedSlots[countDates] = dates;
                countSlots++;
            }
            return transformedSlots;
        }
    });
  </script>
</dom-module>
