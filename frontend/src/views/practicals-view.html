<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared/shared-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../components/practical-date-detail.html">


<dom-module id="practicals-view">
    <template>
        <style include="shared-styles">
            :host {
                #display: block;
            }

            .page {
                #border-radius: 25px;
                margin: 24px;
                background-color: var(--paper-blue-grey-100);
                color: var(--paper-blue-grey-900);
            }

            .tabheader {
                background-color: var(--paper-blue-grey-900);
                font-size: 120%;
                #border-radius: 25px 25px 0px 0px;
                overflow: hidden;
                height: 5vh;
            }

            .tabheaderbuttons {
                color: var(--paper-blue-grey-50);
                text-align: center;
            }

            .backbutton {
                width: 70px;
                --paper-icon-button-ink-color: var(--paper-blue-grey-300);
                padding-right: 30px;
            }

            .firsttab {
                padding-left: 25px;
            }

            paper-tab {
                --paper-tab-ink: var(--paper-blue-grey-100);
                font-weight: 300;
            }

            paper-tab.iron-selected {
                color: var(--paper-blue-grey-900);
                background-color: var(--paper-blue-grey-100);
            }

            .icon {
                position: absolute;
                margin-left: 40px;
                margin-top: -5px;
                width: 64px;
                height: 64px;
                width: 6vh;
                height: 6vh;
                border-radius: 50%;
                background-color: var(--paper-blue-grey-100);
                border: 3px solid var(--paper-blue-grey-900);
                z-index: 1;
            }

            .content {
                padding: 10px;
            }
        </style>

        <div class="page">
            <img class="icon" src=[[icon]] z-index="1">

            <paper-tabs selected="{{selectedTab}}" class="tabheader" no-slide>
                <paper-icon-button class="tabheaderbuttons backbutton" icon="icons:arrow-back"
                                   on-tap="_backClicked"></paper-icon-button>
                <paper-tab class="tabheaderbuttons firsttab">Allgemein</paper-tab>
                <paper-tab class="tabheaderbuttons">Termine</paper-tab>
            </paper-tabs>
            <div class="content">
                <h2>[[type]] Praktikum</h2>
                <iron-pages selected="[[selectedTab]]">
                    <div>
                        <template is="dom-if" if="[[ practical_data.registration_open ]]">
                            Die Registrierungsphase ist noch bis zum [[ practical_data.registration_deadline-string ]] aktiv.<br>
                            Bitte tragt eure Prioritäten für die Termine ein.<br>
                        </template>
                        <template is="dom-if" if="[[ !practical_data.registration_open ]]">
                            Die Registrierungsphase ist abgeschlossen. <br>
                        </template>
                        Eure Prioritäten für dieses Praktikum:
                        <ul>
                        <template is="dom-repeat" items="[[ lab_prios ]]" as="item">
                            <li>Priorität [[item.priority]] für den Termin am [[item.lab]]</li>
                        </template>
                        </ul>
                    </div>
                    <div>
                        <api-request
                                id="ajax_labtypes"
                                body="[[ ajax.body ]]"
                                headers="[[ ajax.headers ]]"
                                method="[[ ajax.method ]]"
                                endpoint="[[ ajax.endpoint ]]"
                                response="{{ response_labtypes }}"
                                loading="{{ isLoading }}"></api-request>
                        <api-request
                                id="ajax_priorities"
                                body="[[ ajax.body ]]"
                                headers="[[ ajax.headers ]]"
                                method="[[ ajax.method ]]"
                                endpoint="[[ ajax.endpoint ]]"
                                response="{{ response_priorities }}"
                                loading="{{ isLoading }}"></api-request>
                        <api-request
                                id="ajax_labIds"
                                body="[[ ajax.body ]]"
                                headers="[[ ajax.headers ]]"
                                method="[[ ajax.method ]]"
                                endpoint="[[ ajax.endpoint ]]"
                                response="{{ response_labIds }}"
                                loading="{{ isLoading }}"></api-request>

                        <template is="dom-if" if="[[ practical_data.registration_open ]]">
                            <practical-date-detail id="practicalDateDetail_[[type]]" type="[[type]]"
                                                   practical_date="[[practical_date]]"
                                                   timeslots="[[timeslots]]"
                                                   access-token="[[ accessToken ]]"
                                                   on-save-click="_handleSaveClick"
                                                   on-reset-click="_handleResetClick"></practical-date-detail>
                        </template>
                        <template is="dom-if" if="![[ practical_data.registration_open ]]">
                            Die Registrierungsphase ist abgeschlossen.<br>
                        </template>

                    </div>
                </iron-pages>
            </div>
        </div>
    </template>

    <script>
        Polymer({

            is: 'practicals-view',
            properties: {
                accessToken: {
                    type: String
                },
                chosenslots: {
                    type: Array,
                    value: []
                },
                icon: {
                    type: String
                },
                practical_date: {
                    type: Date,
                    notify: true
                },
                route: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: String,
                    value: "0"
                },
                timeslots: {
                    type: Array,
                    value: []
                },
                type: {
                    type: String,
                    notify: true,
                    value: ""
                },
                practical_data: {
                    type: Object,
                    value: {}
                },
                headers: {
                    type: Object,
                    value: {}
                },
                isReady: {
                    type: Boolean,
                    value: false
                },
                group: Object,
                lab_prios: {
                    type: Array,
                    observer: '_labpriosChanged'
                },
                response_priorities: {
                    type: Object,
                    observer: "_prioritiesChanged"
                },
                response_labtypes: {
                    type: Object,
                    observer: "_labtypesChanged"
                },
                response_labIds: {
                    type: Object,
                    observer: "_labIdsChanged"
                }
            },
            ready: function () {
                this.practical_date = this._getDate();
                if (this.practical_date == null) {
                    this.timeslots = this._getTimeslots();
                }
                this.isReady = true;

                // Get labTypeId for current lab (in order to fetch priorities later)
                this.$.ajax_labtypes.endpoint = '/LabTypes/findOne?filter[where][type_str]=' + this.type;
            },

            /**
             * Back-button click handler
             */
            _backClicked: function () {
                this.type = "";
                this.fire("back-click");
                if (typeof this.$.practicalDateDetail !== 'undefined')
                    this.$.practicalDateDetail._handleResetClick();
            },

            _labtypesChanged: function (response) {

                if (!this.isReady)
                    return;

//                console.log("_labtypes changed for " + this.type);
//                console.log(response);

                if (typeof response !== 'undefined' && response.data != 0) {

                    deadline_date = new Date(response.data.registration_deadline);

                    course = {
                        "registration_open": response.data.registration_open,
                        "registration_deadline-object": deadline_date,
                        "registration_deadline-string": deadline_date.getDate() + "." + (deadline_date.getMonth()+1) +
                            "." + deadline_date.getFullYear() + ", " + deadline_date.getHours() + ":" + deadline_date.getMinutes(),
                        "description_tutor": response.data.description_tutor,
                        "description_student": response.data.description_student,
                        "labtype_id": response.data.id
                    };
                    this.practical_data = course;
//                    console.log("type= " + this.type)
                    this.$.ajax_priorities.endpoint = '/Groups/' + this.group.id + '/priorities?filter[where][labTypeId]=' + course.labtype_id;
                }
                else {
                    console.log("error!");
                    console.log(response);
                }
            },

            /**
             * Handle save click
             * @param e - Event Variable
             * @private
             */
            _handleSaveClick: function (e) {
                var dateselect_element = this.$$("#practicalDateDetail_" + this.type);
                chosenslots = dateselect_element.chosenslots;
                console.log(chosenslots);
            },

            _handleResetClick: function (e) {
                this.chosenslots = [];
            },

            /**
             * Function that checks for the practial course date
             * @param {String} date - date that will be transformed to String
             */
            _getDate: function () {
                //TODO: Check for Practicalsdates in Backend
                return null;
                //return new Date(2017,2,25,14,0);

            },

            /**
             * Function that checks for the practial course date
             * @param {String} date - date that will be transformed to String
             */
            _getTimeslots: function () {
                //TODO: Get Timeslots from Backend
                var timeslots = [];
                timeslots.starttimes = [new Date(2017, 1, 2, 1, 0), new Date(2017, 1, 2, 2, 0), new Date(2017, 1, 2, 3, 0), new Date(2017, 1, 2, 4, 0), new Date(2017, 1, 2, 5, 0),
                    new Date(2017, 1, 10, 14, 0), new Date(2017, 1, 10, 15, 0), new Date(2017, 1, 10, 16, 0), new Date(2017, 1, 10, 17, 0), new Date(2017, 1, 10, 18, 0), new Date(2017, 1, 10, 19, 0), new Date(2017, 1, 10, 20, 0),
                    new Date(2017, 1, 12, 12, 0), new Date(2017, 1, 12, 13, 0), new Date(2017, 1, 12, 14, 0), new Date(2017, 1, 12, 15, 0), new Date(2017, 1, 14, 14, 0), new Date(2017, 1, 14, 15, 0)];
                timeslots.sizes = [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60];

                return this._transformTimeslots(timeslots);
                //return null;
            },

            /**
             * Transform the Format of the given Timeslots from the Api, so it will be easier to handle in the frontend
             * @param slotsFromApi - Contains the given timeslots
             * @returns {Array} - timeslots in new format
             * @private
             */
            _transformTimeslots: function (slotsFromApi) {
                var transformedSlots = []; //Store return-Array here
                var lastSlot = slotsFromApi.starttimes[0];
                var countDates = 0; //Date counter
                var countSlots = 0; //Slot counter
                var dates = [];

                for (i = 0; i < slotsFromApi.starttimes.length; i++) {
                    // Create a new array-entrie if date from recent slot is different from date of the last slot
                    if (slotsFromApi.starttimes[i].getFullYear() != lastSlot.getFullYear() ||
                        slotsFromApi.starttimes[i].getMonth() != lastSlot.getMonth() ||
                        slotsFromApi.starttimes[i].getDate() != lastSlot.getDate()) {
                        dates = [];
                        lastSlot = slotsFromApi.starttimes[i];
                        transformedSlots.push([]);
                        countDates++;
                        countSlots = 0;
                    }
                    var endtime = new Date(slotsFromApi.starttimes[i].getFullYear(), slotsFromApi.starttimes[i].getMonth(), slotsFromApi.starttimes[i].getDate());
                    if ((slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60)) > 60) {
                        endtime.setHours(1 + Math.floor(slotsFromApi.starttimes[i].getHours() + (slotsFromApi.sizes[i]) / 60));
                        endtime.setMinutes(slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60) - 60);
                    }
                    else {
                        endtime.setHours(Math.floor(slotsFromApi.starttimes[i].getHours() + (slotsFromApi.sizes[i]) / 60));
                        endtime.setMinutes(slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60));
                    }

                    var slot = [];
                    slot = [slotsFromApi.starttimes[i], endtime];
                    dates[countSlots] = slot;
                    transformedSlots[countDates] = dates;
                    countSlots++;
                }
                return transformedSlots;
            },

            /**
             * Handler to process priority data from API
             * @param response
             * @private
             */
            _prioritiesChanged: function (response) {
                if (!this.isReady || typeof response == 'undefined' || response.data.length == 0)
                    return;

                var newPrios = [];
                var type = this.type;

                for (var i = 0; i < response.data.length; i ++) {
                    var append = true;
                    for (var j = 0; j <  newPrios.length; j++) {
                        if (newPrios[j].id == response.data[i].id) {
                            if (newPrios[j].labId != response.data[i].labId || newPrios[j].priority != response.data[i].priority) {
                                append = false;
                                newPrios[j].id = response.data[i].id;
                                newPrios[j].priority = response.data[i].priority;
                                newPrios[j].labId = response.data[i].labId;
                            }
                        }
                        if (!append)
                            break;
                    }
                    if (append) {
                        var prio = {
                            id : response.data[i].id,
                            priority : response.data[i].priority,
                            labId : response.data[i].labId
                        };
                        newPrios.push(prio);
                    }
                }

//                console.log("priorities is now for type " + this.type)
//                console.log(newPrios)

                this.lab_prios = newPrios;
            },

            /**
             * Handler to process lab data per priority from API.
             * @param response
             * @private
             */
            _labIdsChanged: function (response){
                if (!this.isReady)
                    return;
                console.log("lab is at " + response.data.date  + " // Type " + this.type)
                console.log(response);

                for(var i = 0; i < this.lab_prios.length; i++) {
                    if (response.data.id == this.lab_prios[i].labId) {
                        this.lab_prios[i].lab = response.data;
                    }
                }
                console.log(this.lab_prios)
            },

            /**
             * Handler to fetch lab data, for priorities that have been changed, from API
             * @param priorities
             * @private
             */
            _labpriosChanged: function(priorities) {
                if (!this.isReady)
                    return;
                console.log("PRIO CHANGED for " + this.type)
                console.log(priorities)
                for (var i = 0; i < priorities.length; i++) {
                   this.$.ajax_labIds.endpoint = '/Priorities/' + priorities[i].id + '/lab';
                }
            }
        });
    </script>
</dom-module>
