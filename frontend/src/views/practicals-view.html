<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared/shared-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../components/practical-date-detail.html">


<dom-module id="practicals-view">
    <template>
        <style include="shared-styles">
            :host {
                #display: block;
            }

            .page {
                #border-radius: 25px;
                margin: 24px;
                background-color: var(--paper-blue-grey-100);
                color: var(--paper-blue-grey-900);
            }

            .tabheader {
                background-color: var(--paper-blue-grey-900);
                font-size: 120%;
                #border-radius: 25px 25px 0px 0px;
                overflow: hidden;
                height: 5vh;
            }

            .tabheaderbuttons {
                color: var(--paper-blue-grey-50);
                text-align: center;
            }

            .backbutton {
                width: 70px;
                --paper-icon-button-ink-color: var(--paper-blue-grey-300);
                padding-right: 30px;
            }

            .firsttab {
                padding-left: 25px;
            }

            paper-tab {
                --paper-tab-ink: var(--paper-blue-grey-100);
                font-weight: 300;
            }

            paper-tab.iron-selected {
                color: var(--paper-blue-grey-900);
                background-color: var(--paper-blue-grey-100);
            }

            .icon {
                position: absolute;
                margin-left: 40px;
                margin-top: -5px;
                width: 64px;
                height: 64px;
                width: 6vh;
                height: 6vh;
                border-radius: 50%;
                background-color: var(--paper-blue-grey-100);
                border: 3px solid var(--paper-blue-grey-900);
                z-index: 1;
            }

            .content {
                padding: 10px;
            }
        </style>

        <api-request
                id="ajax_savePriorities"
                body="[[ ajax.body ]]"
                headers="[[ ajax.headers ]]"
                method="[[ ajax.method ]]"
                endpoint="[[ ajax.endpoint ]]"
                response="{{ response_savePriorities }}"
                loading="{{ isLoading }}"></api-request>

        <div class="page">
            <img class="icon" src=[[icon]] z-index="1">
            <paper-tabs selected="{{selectedTab}}" class="tabheader" no-slide>
                <paper-icon-button class="tabheaderbuttons backbutton"
                                   icon="icons:arrow-back"
                                   on-tap="_backClicked"></paper-icon-button>
                <paper-tab class="tabheaderbuttons firsttab">Allgemein</paper-tab>
                <paper-tab class="tabheaderbuttons">Termine</paper-tab>
            </paper-tabs>
            <div class="content">
                <h2>[[type]] Praktikum</h2>
                <iron-pages selected="[[selectedTab]]">
                    <div>Page 1 Text</div>
                    <div>
                        <practical-date-detail
                            id="practicalDateDetail"
                            type="[[type]]"
                            api-priorities="{{ labdata.priorities }}"
                            practical_date="[[practical_date]]"
                            timeslots="[[timeslots]]"
                            on-save-click="_handleSaveClick"
                            on-reset-click="_handleResetClick">
                        </practical-date-detail>
                    </div>
                </iron-pages>
            </div>
        </div>
    </template>

    <script>
        Polymer({

            is: 'practicals-view',
            properties: {
                accessToken: {
                    type: String,
                    notify: true
                },
                chosenslots: {
                    type: Array,
                    value: []
                },
                icon: {
                    type: String
                },
                practical_date: {
                    type: Date,
                    notify: true
                },
                route: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: String,
                    value: "0"
                },
                timeslots: {
                    type: Array,
                    value: []
                },
                type: {
                    type: String,
                    notify: true,
                    value: ""
                },
                isReady: {
                    type: Boolean,
                    value: false
                },
                response_savePriorities: {
                    type: Object,
                    observer: '_responseFromPrioritySave'
                },
                labData: Object,
                labType: Object

            },
            ready: function () {
                this.isReady = true;
                this.practical_date = this._getDate();
                if (this.practical_date == null) {
                    this.timeslots = this._getTimeslots();
                }
            },

            /**
             * Back-button click handler
             */
            _backClicked: function () {
                this.type = "";
                this.fire("back-click");
                if (typeof this.$.practicalDateDetail != 'undefined')
                    this.$.practicalDateDetail._handleResetClick();
            },

            /**
             * Handle save click
             * @param e - Event Variable
             * @private
             */
            _handleSaveClick: function (e) {
                chosenslots = e.detail;
                console.log(chosenslots.length);

                // TODO: Deliver chosen slots as lab objects (with Id)

                // IMPORTANT: This is the example process for saving priorities.
                // The process has to be done for each set priority (every
                // entry in chosenslots)

                for (var i = 0; i < chosenslots.length; i++) {

                    // TODO: Replace this by chosenslot entry as lab object
                    var dummyLab = {};

                    // Step 1. check if this priority has been in the DB for this group already
                    var found = false;
                    for (var i = 0; i < this.labdata.priorities.length; i ++) {
                        if (this.labdata.priorities[i].id == dummyLab.id) {
                            found = true;
                            break;
                        }
                    }
                    if (found)
                        // take next priority / go on in loop over chosenslots
                        break;

                    // Step 2. Save a new priority object
                    this.ajax = {
                        endpoint: '/groups/' + this.group.id + 'priorities?filter[where][semesterId]=' + this.group.semesterId,
                        method: 'POST',
                        headers: {
                            'Authorization' : this.accessToken
                        },
                        body: {
                            priority: 3,
                            groupId: this.group.id,
                            labId: dummyLab.id, // TODO: Set this (= current slot's lab id)
                            semesterId: this.group.semesterId,
                            labTypeId: this.labType.id
                        }
                    }
                }
            },

            _handleResetClick: function (e) {
                this.chosenslots = [];
            },

            /**
             * Function that checks for the practial course date
             * @param {String} date - date that will be transformed to String
             */
            _getDate: function () {
                //TODO: Check for Practicalsdates in Backend
//                if (typeof this.labdata.lab == 'undefined') {
//                    // Lab is not set for this practical
                    return null;
//                }
//                else
//                    return new Date(this.labdata.lab.date)

            },

            /**
             * Function that checks for the practial course date
             * @param {String} date - date that will be transformed to String
             */
            _getTimeslots: function () {
                //TODO: Get Timeslots from Backend
                var timeslots = [];
                timeslots.starttimes = [new Date(2017, 1, 2, 1, 0), new Date(2017, 1, 2, 2, 0), new Date(2017, 1, 2, 3, 0), new Date(2017, 1, 2, 4, 0), new Date(2017, 1, 2, 5, 0),
                    new Date(2017, 1, 10, 14, 0), new Date(2017, 1, 10, 15, 0), new Date(2017, 1, 10, 16, 0), new Date(2017, 1, 10, 17, 0), new Date(2017, 1, 10, 18, 0), new Date(2017, 1, 10, 19, 0), new Date(2017, 1, 10, 20, 0),
                    new Date(2017, 1, 12, 12, 0), new Date(2017, 1, 12, 13, 0), new Date(2017, 1, 12, 14, 0), new Date(2017, 1, 12, 15, 0), new Date(2017, 1, 14, 14, 0), new Date(2017, 1, 14, 15, 0)];
                timeslots.sizes = [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60];

                return this._transformTimeslots(timeslots);
                //return null;
            },

            /**
             * Transform the Format of the given Timeslots from the Api, so it will be easier to handle in the frontend
             * @param slotsFromApi - Contains the given timeslots
             * @returns {Array} - timeslots in new format
             * @private
             */
            _transformTimeslots: function (slotsFromApi) {
                var transformedSlots = []; //Store return-Array here
                var lastSlot = slotsFromApi.starttimes[0];
                var countDates = 0; //Date counter
                var countSlots = 0; //Slot counter
                var dates = [];

                for (i = 0; i < slotsFromApi.starttimes.length; i++) {
                    // Create a new array-entrie if date from recent slot is different from date of the last slot
                    if (slotsFromApi.starttimes[i].getFullYear() != lastSlot.getFullYear() ||
                        slotsFromApi.starttimes[i].getMonth() != lastSlot.getMonth() ||
                        slotsFromApi.starttimes[i].getDate() != lastSlot.getDate()) {
                        dates = [];
                        lastSlot = slotsFromApi.starttimes[i];
                        transformedSlots.push([]);
                        countDates++;
                        countSlots = 0;
                    }
                    var endtime = new Date(slotsFromApi.starttimes[i].getFullYear(), slotsFromApi.starttimes[i].getMonth(), slotsFromApi.starttimes[i].getDate());
                    if ((slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60)) > 60) {
                        endtime.setHours(1 + Math.floor(slotsFromApi.starttimes[i].getHours() + (slotsFromApi.sizes[i]) / 60));
                        endtime.setMinutes(slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60) - 60);
                    }
                    else {
                        endtime.setHours(Math.floor(slotsFromApi.starttimes[i].getHours() + (slotsFromApi.sizes[i]) / 60));
                        endtime.setMinutes(slotsFromApi.starttimes[i].getMinutes() + (slotsFromApi.sizes[i] % 60));
                    }

                    var slot = [];
                    slot = [slotsFromApi.starttimes[i], endtime];
                    dates[countSlots] = slot;
                    transformedSlots[countDates] = dates;
                    countSlots++;
                }
                return transformedSlots;
            },

            /**
             * Gets response from API call to create a new priority
             * @param response
             * @private
             */
            _responseFromPrioritySave: function(response) {
                if (!this.isReady)
                    return;
                console.log(response)
            }
        });
    </script>
</dom-module>
