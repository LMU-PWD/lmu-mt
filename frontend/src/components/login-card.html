<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../shared/shared-styles.html">

<dom-module is="login-card">

    <template>

        <style>

            :host {
                max-width: 400px;
                padding: 10px;
                width: 100%;
            }

            a {
                color: var(--paper-blue-grey-800);
            }

            paper-card {
                width: 100%;
                --paper-card-background-color: var(--paper-blue-grey-100);
                --paper-card-header-color: var(--paper-blue-grey-50);

                --paper-card-header: {
                    background: var(--paper-blue-grey-900);
                };

                --paper-card-actions: {
                    border: 0;
                };
            }

            paper-button {
                background-color: var(--paper-blue-grey-900);
                color: var(--paper-blue-grey-50);
                margin: 0;
                width: 100%;
            }

            paper-input {
                --paper-input-container-color: var(--paper-blue-grey-500);
                --paper-input-container-focus-color: var(--paper-blue-grey-900);
            }

            .card-content p {
                margin-top: 0;
            }

        </style>

        <iron-ajax
            auto
            body="[[ ajax.body ]]"
            content-type="[[ ajax.contentType ]]"
            handle-as="json"
            method="[[ ajax.method ]]"
            on-error="_handleLoginError"
            on-response="_handleLoginResponse"
            url="[[ ajax.url ]]"
            verbose
            with-credentials="true"></iron-ajax>

        <paper-card heading="Login">
            <div class="card-content">
                <p>{{localize('logincardcard_welcome text-1')}} <em>{{localize('c_medientechnik')}}</em>{{localize('logincard_welcome text-2')}}</p>
                <paper-input
                        label="E-Mail"
                        type="email"
                        value="{{ userInput.email }}"
                        on-keydown="_onEnterFireLoginRequest"></paper-input>
                <paper-input
                        label="{{localize('logincard_password placeholder')}}"
                        type="password"
                        value="{{ userInput.password }}"
                        on-keydown="_onEnterFireLoginRequest"></paper-input>
            </div>
            <div class="card-actions" style="padding: 20px">
                <paper-button on-tap="_fireLoginRequest">{{localize('logincard_login button')}}</paper-button>
                <!--<p>{{localize('logincardcard_register text')}} <a href="#">{{localize('logincardcard_register button')}}</a></p>-->
            </div>
        </paper-card>

    </template>

    <script>

        Polymer({

            is: 'login-card',

            properties: {

                  language: {
                    value: 'en',
                    type: String
                  },

                accessToken: {
                    type: String,
                    notify: true
                },

                loggedIn: {
                    type: Boolean,
                    notify: true
                },

                userId: {
                    type: String,
                    notify: true
                },

                userInput: {
                    type: Object,
                    value: {
                        email: "",
                        password: ""
                    }
                }

            },

          behaviors: [
            Polymer.AppLocalizeBehavior
          ],

          attached: function() {
            this.loadResources(this.resolveUrl('../shared/locales.json'));
          },

            /**
             * Callback fired when user clicks submit button. Sets a property
             * `ajax` containing information for login API call
             * @private
             */
            _fireLoginRequest: function () {
                this.ajax = {
                    body: {
                        email: this.userInput.email,
                        password: this.userInput.password
                    },
                    contentType: 'application/json',
                    method: 'POST',
                    url: 'http://lmu-mt-api.herokuapp.com/api/platformusers/login'
//                    url: 'http://localhost:3000/api/platformusers/login'
                };

                // Reset input fields (in case of immediate logout users
                // should not have the impression we saved their credentials)
                this.set('userInput.email', '');
                this.set('userInput.password', '');
            },

            _onEnterFireLoginRequest: function (event) {

                if (event.keyCode === 13) {
                    this._fireLoginRequest();
                }

            },

            /**
             * Callback fired when API gives positive response
             * @param {Object} response
             * @private
             */
            _handleLoginResponse: function (response) {

                var jsonResponse = response.detail.response;

                // Save session info to cookies
                var expires = new Date();
                expires.setTime(expires.getTime() + (jsonResponse.ttl * 1000));
                document.cookie = 'mt-api-accesstoken=' + jsonResponse.id + ';expires=' + expires.toUTCString() + ';';
                document.cookie = "mt-api-userid=" + jsonResponse.userId + ';expires=' + expires.toUTCString() + ';';

                // Set global session properties
                this.set('accessToken', jsonResponse.id);
                this.set('userId', jsonResponse.userId);
                this.set('loggedIn', true);
            },

            /**
             * Callback fired when API answers with an error
             * @param response
             * @private
             */
            _handleLoginError: function (response) {
                console.log(response.detail.error);
            }

        });

    </script>

</dom-module>