<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../shared/shared-styles.html">

<dom-module is="login-card">

    <template>

        <style>

            :host {
                max-width: 400px;
                padding: 10px;
                width: 100%;
            }

            a {
                color: var(--paper-blue-grey-800);
            }

            paper-card {
                width: 100%;
                --paper-card-background-color: var(--paper-blue-grey-100);
                --paper-card-header-color: var(--paper-blue-grey-50);

                --paper-card-header: {
                    background: var(--paper-blue-grey-900);
                };

                --paper-card-actions: {
                    border: 0;
                };
            }

            paper-button {
                background-color: var(--paper-blue-grey-900);
                color: var(--paper-blue-grey-50);
                margin: 0;
                width: 100%;
            }

            paper-input {
                --paper-input-container-color: var(--paper-blue-grey-500);
                --paper-input-container-focus-color: var(--paper-blue-grey-900);
            }

            .card-content p {
                margin-top: 0;
            }

        </style>

        <api-request
                body="[[ ajax.body ]]"
                method="[[ ajax.method ]]"
                endpoint="[[ ajax.endpoint ]]"
                response="{{ apiResponse }}"></api-request>

        <paper-card heading="Login">
            <div class="card-content">
                <p>Willkommen bei <em>Medientechnik</em>. Bitte melde dich mit deiner Campus-Mailadresse an.</p>
                <paper-input
                        label="E-Mail"
                        type="email"
                        value="{{ userInput.email }}"
                        on-keydown="_onEnterFireLoginRequest"></paper-input>
                <paper-input
                        label="Password"
                        type="password"
                        value="{{ userInput.password }}"
                        on-keydown="_onEnterFireLoginRequest"></paper-input>
            </div>
            <div class="card-actions" style="padding: 20px">
                <paper-button on-tap="_fireLoginRequest">Einloggen</paper-button>
                <p>Neu hier? <a href="#/login/register">Registrieren</a></p>
            </div>
        </paper-card>

    </template>

    <script>

        Polymer({

            is: 'login-card',

            properties: {

                apiResponse: {
                    type: String,
                    reflectToAttribute: false,
                    observer: '_apiResponseChanged'
                },

                accessToken: {
                    type: String,
                    notify: true
                },

                loggedIn: {
                    type: Boolean,
                    notify: true
                },

                userId: {
                    type: String,
                    notify: true
                },

                userInput: {
                    type: Object,
                    value: {
                        email: "",
                        password: ""
                    }
                }

            },

            /**
             * Callback fired when user clicks submit button. Sets a property
             * `ajax` containing information for login API call
             * @private
             */
            _fireLoginRequest: function () {
                this.ajax = {
                    body: {
                        email: this.userInput.email,
                        password: this.userInput.password
                    },
                    method: 'POST',
                    endpoint: '/platformusers/login'
                };

                // Reset input fields (in case of immediate logout users
                // should not have the impression we saved their credentials)
                this.set('userInput.email', '');
                this.set('userInput.password', '');
            },

            _onEnterFireLoginRequest: function (event) {

                if (event.keyCode === 13) {
                    this._fireLoginRequest();
                }

            },

            _apiResponseChanged: function (response) {
                if (response.type == 'error') {

                } else if (response.type == 'response') {

                    var jsonResponse = response.data;

                    // Save session info to cookies
                    var expires = new Date();
                    expires.setTime(expires.getTime() + (jsonResponse.ttl * 1000));
                    document.cookie = 'mt-api-accesstoken=' + jsonResponse.id + ';expires=' + expires.toUTCString() + ';';
                    document.cookie = "mt-api-userid=" + jsonResponse.userId + ';expires=' + expires.toUTCString() + ';';

                    // Set global session properties
                    this.set('accessToken', jsonResponse.id);
                    this.set('userId', jsonResponse.userId);
                    this.set('loggedIn', true);

                }
            }

        });

    </script>

</dom-module>