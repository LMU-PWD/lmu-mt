<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../shared/shared-styles.html">
<link rel="import" href="../services/get-user-info.html">
<link rel="import" href="../services/get-access-token.html">
<link rel="import" href="mail-input.html">

<dom-module id="group-detail">

    <template>

        <style include="shared-styles">
            :host {
                height: auto;
                min-width: 320px;
                width: 100%;
                background-color: var(--paper-blue-grey-100);
                display: block;
                position: relative;
                /*top: 1px;*/
                border-top: 1px solid var(--paper-blue-grey-900);
                /*border-radius: 0 0 5px 5px;*/
            }

            .info {
                display: block;
                padding: 5px;
            }

            .info > .member {
                margin: 10px;
                padding: 10px;
                border: 1px solid var(--paper-blue-grey-700);
                background-color: var(--paper-blue-grey-50);
                border-radius: 5px;
                height: 30px;
                overflow: hidden;
            }

            .info > .member > h2 {

                position: relative;
                margin: 0 0 0 50px;
                width: calc(100% - 50px);
                top: -5px;
                color: var(--paper-blue-grey-700);
            }

            .info > .member > a {
                float: left;
                width: 50px;
                position: relative;
                top: -5px;
            }

            .info > .member > a > paper-icon-button {
                color: var(--paper-blue-grey-700);
            }

            .create-group {
                background-color: var(--paper-blue-grey-50);
                border-radius: 5px;
                padding: 10px 20px;
            }

            .create-group-input iron-icon {
                margin-right: 5px;
            }

            .error {
                position: relative;
                display: none;
                text-align: center;
                white-space: normal;
            }

            .error[invalid] {
                display: block;
            }

            .random {
                background-color: var(--paper-blue-grey-50);
                border-radius: 5px;
                padding: 10px 20px;
                margin-bottom: 5px;

            }

            .join {
                display: block;
                padding: 20px;
            }

            paper-spinner {
                display: none;
            }

            paper-input {
                --paper-input-container-color: var(--paper-blue-grey-600);
                --paper-input-container-focus-color: var(--paper-blue-grey-800);
            }

            paper-spinner[active] {
                display: block;
                position: absolute;
                height: 50px;
                width: 50px;
                left: 0;
                top: 0;
                background-color: rgba(255, 255, 255, 0.8);
                padding: calc(50% - 10px) calc(50% - 25px);
                z-index: 100;
            }

            paper-input[wronginput] {
                color: var(--paper-red-500);
            }
        </style>

        <div>
            <content>
                <paper-spinner active="[[isLoading]]"></paper-spinner>
            </content>
        </div>

        <!-- Checking for Group ID if User Joined Group-->
        <template is="dom-if" if="{{selfInfo.groupId}}">

            <div class="info">

                <!-- Dieser Request soll anhand der ID die Gruppeninfo holen -->
                <api-request
                        headers="[[ ajax.headers ]]"
                        method="[[ ajax.method ]]"
                        endpoint="[[ ajax.endpoint ]]"
                        response="{{ apiGetGroupResponse }}"
                        loading="{{ isLoading }}"></api-request>

                <template is="dom-repeat" items="[[group.groupMemberIds]]" as="member">
                    <div class="member">
                        <get-user-info
                                access-token="[[ accessToken ]]"
                                user-id="[[member.id]]"
                                name="{{member.name}}"
                                mail="{{member.mail}}"></get-user-info>
                        <a id="mail-[[member.id]]" href="mailto:[[member.mail]]" tabindex="-1">
                            <paper-icon-button icon="icons:mail"></paper-icon-button>
                        </a>
                        <paper-tooltip for="mail-[[member.id]]" offset="5">{{localize('groupdetail_write mail')}}
                        </paper-tooltip>
                        <h2>[[member.name]]</h2>
                    </div>
                </template>

            </div>

        </template>

        <template is="dom-if" if="{{!selfInfo.groupId}}">

            <div class="join">
                <!-- Random Join Auskommentiert, da noch nicht unterstützt
                <div class="random">
                    <paper-button disabled>Zufälliger Beitritt</paper-button>
                </div>-->
                <div class="create-group">
                    <paper-input class="create-group-input"
                                 label="You"
                                 value="{{convertMail(selfInfo.email)}}"
                                 readonly>
                        <iron-icon icon="mail" prefix></iron-icon>
                        <div suffix>@campus.lmu.de</div>
                    </paper-input>
                    <template is="dom-repeat" items="{{members}}" as="member">
                        <paper-input class="create-group-input"
                                     label="Member [[calcNaturalIndex(index)]]"
                                     value="{{member.name}}"
                                     required>
                            <iron-icon icon="mail" prefix></iron-icon>
                            <div suffix>@campus.lmu.de</div>
                        </paper-input>
                    </template>
                    <paper-button on-tap="_createNewGroup">{{localize('groupdetail_create group')}}</paper-button>
                    <paper-input-error id="inputError" class="error">
                        Du musst zu viert sein um eine neue Gruppe zu erstellen
                    </paper-input-error>
                    <paper-input-error id="requestError" class="error">
                        Uuups... hat haben wohl die E-Mails nicht gestimmt
                    </paper-input-error>

                    <api-request
                            body="[[ ajax.body ]]"
                            headers="[[ ajax.headers ]]"
                            method="[[ ajax.method ]]"
                            endpoint="[[ ajax.endpoint ]]"
                            response="{{ apiCreateGroupResponse }}"
                            loading="{{ isLoading }}"></api-request>
                </div>
            </div>
            <iron-signals on-iron-signal-switchlocale="_switchLocale"></iron-signals>
        </template>

    </template>
    <script>
        Polymer({
            is: 'group-detail',
            properties: {
                accessToken: String,
                apiGetGroupResponse: {
                    type: String,
                    reflectToAttribute: false,
                    observer: '_apiGetGroupResponseChanged'
                },
                apiCreateGroupResponse: {
                    type: String,
                    reflectToAttribute: false,
                    observer: '_apiCreateGroupResponseChanged'
                },
                group: {
                    type: Object,
                    notify: true,
                    readOnly: false
                },
                groupSize: {
                    //TODO make input dependent
                    type: Number,
                    value: 4
                },
                isLoading: {
                    type: Boolean,
                    value: false
                },
                members: {
                    type: Array,
                    reflectToAttribute: false,
                    notify: true
                },
                selfInfo: {
                    type: Object,
                    notify: true,
                    readOnly: false,
                    value: {
                        groupId: ''
                    }
                },
                language: {
                    type: String,
                    value: 'de'
                }
            },
            observers: [
                '_selfInfoGroupIdChanged(selfInfo.groupId)'
            ],

            /**
             * Localization setup
             */
            behaviors: [
                Polymer.AppLocalizeBehavior
            ],
            attached: function () {
                this.loadResources(this.resolveUrl('../shared/locales.json'));
            },
            _switchLocale: function () {
                this.language = (this.language == 'en') ? 'de' : 'en';
            },

            ready: function () {

                this.members = [];
                for (var i = 1; i < this.groupSize; i++) {
                    this.members.push({"name": ""});
                }
            },
            _selfInfoGroupIdChanged: function () {

                if (this.selfInfo.groupId) {

                    this.ajax = {
                        contentType: 'application/json',
                        headers: {
                            Authorization: this.accessToken
                        },
                        method: 'GET',
                        endpoint: '/groups/' + this.selfInfo.groupId
                    }
                }

            },

            convertMail: function (mail) {
                if (!mail) {
                    return "";
                } else if (mail.includes("@campus.lmu.de")) {
                    return mail.slice(0, -14);
                }
                return mail.split("@")[0];
            },

            _createNewGroup: function () {
                var checked = true;

                //Restet Errors to not visible
                this.$$('#requestError').toggleAttribute("invalid", false);
                this.$$('#inputError').toggleAttribute("invalid", false);

                //Check for empty inputs
                this.members.forEach(function (element) {
                    if (element.name == "") {
                        console.log('element was empty');
                        checked = false;
                    }
                });

                if (checked) {
                    var mails = [];
                    //Add suffix back to Mails and Push to Array
                    this.members.forEach(function (element) {
                        mails.push(element.name.concat("@campus.lmu.de"));
                    });

                    this.ajax = {
                        headers: {
                            Authorization: this.accessToken
                        },
                        method: 'POST',
                        body: {
                            "emails": mails
                        },
                        endpoint: '/groups/createbymail/'
                    };
                } else {
                    this.$$('#inputError').toggleAttribute("invalid", true);
                }
            },

            calcNaturalIndex: function (index) {
                return index + 1;
            },

            /**
             * Callback fired when api-request responds to GET on current group.
             * @param response
             * @private
             */
            _apiGetGroupResponseChanged: function (response) {

                if (response.type == 'response') {
                    var self = this;
                    var receivedGroup = response.data;
                    this.set('group', receivedGroup);

                    //Change groupMemberIds to Array Containing Objects with ID, Name and Mail
                    this.group.groupMemberIds.forEach(function () {
                        self.push('group.groupMemberIds', {
                            "id": self.shift('group.groupMemberIds'),
                            "name": "",
                            "mail": ""
                        });
                    });
                }
            },

            /**
             * Callback fired when api-request responds to createByMail request
             * @param apiResponse
             * @private
             */
            _apiCreateGroupResponseChanged: function (apiResponse) {

                if (apiResponse.type == 'response') {
                    var result = apiResponse.data.group;
                    if (result) {
                        this.set('selfInfo.groupId', result.id);
                    }
                } else if (apiResponse.type == 'error') {
                    this.$$('#requestError').toggleAttribute("invalid", true);
                }
            }
        });
    </script>
</dom-module>