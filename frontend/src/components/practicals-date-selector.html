<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="date-creator.html">
<link rel="import" href="calculate-timeslots.html">
<link rel="import" href="../shared/shared-styles.html">

<dom-module id="practicals-date-selector">
    <template>
        <style include="shared-styles">
            :host{

            }
            .dateselector{
                text-align: center;
                width: 100%;
            }
            .datecreator{
                display:inline-block;
                margin:0;
                height: auto;
                vertical-align:top;
            }
            .resetButton{
                margin-bottom: 10px;
                width: 49%;
                float: left;
            }
            .saveButton{
                margin-bottom: 10px;
                width: 49%;
                float: right;
            }
            /*Phone*/
            @media screen and (max-width: 767px) {
                .datecreator{
                    width: 100%;
                }
            }
            /*Tablet*/
            @media screen and (min-width: 768px) and (max-width: 1023px) {
                .datecreator{
                    min-width: 400px;
                    width: 49%;

                }
            }
            /*Desktop*/
            @media screen and (min-width: 1024px) {
                .datecreator{
                    min-width: 400px;
                    width: 24%;
                }
            }
        </style>
            <div>
                <paper-button raised class="resetButton" on-tap="_handleResetClick">
                    <iron-icon icon="reply"></iron-icon>
                        Zur√ºcksetzen
                </paper-button>
                <paper-button raised class="saveButton" on-tap="_handleSaveClick">
                    <iron-icon icon="save"></iron-icon>
                    Speichern
                </paper-button>
            </div>
            <div class="dateselector">
                <template is="dom-repeat" items="[[timeslots]]" as="slots">
                    <date-creator id="dateselectors" class="datecreator" timeslots="[[slots]]" priority="[[priority]]"
                                  on-priority-click="_handlePriorityClick"
                                  on-date-click="_handleDateClick"
                                  on-replace-priority="_handleReplacePriority"></date-creator>
                </template>
            </div>
    </template>
    <script>
        Polymer({
            is: 'practicals-date-selector',
            properties: {
                type:{
                    type: String,
                    notify: true,
                    value: ""
                },
                practical_date: {
                    type: Date,
                    notify: true,
                    observer: '_practicalDateChanged'
                },
                practical_date_string: {
                    type: String,
                    value: "",
                    notify: true
                },
                timeslots:{
                    type: Array,
                    value: []
                },
                priority:{
                    type: Number,
                    value: 5
                },
                priorities:{
                    type: Array,
                    value: []
                },
                chosenslots:{
                    type: Array,
                    value: []
                }
            },

            ready: function() {
                if(this.practical_date != null){
                    this.practical_date_string = this._getDateString(this.practical_date);
                }
                this._fillPrioritiesArray();
            },

            _fillPrioritiesArray: function(){
                for (i = 0; i < this.priority; i++) {
                    this.priorities[i]=i+1;
                }
            },
            /**
             *  Handle practicalChanged Event; Variable practical_date changed
             */
            _practicalDateChanged: function(){
                if(this.practical_date != null){
                    this.practical_date_string = this._getDateString(this.practical_date);
                }
            },

            /**
             * Creates string from the given date
             * @param {String} date - date that will be transformed to String
             */
            _getDateString: function(date){
                var datestring = "";
                switch(date.getDay()){
                    case 0:
                        datestring = "Sonntag, den ";
                        break;
                    case 1:
                        datestring = "Montag, den ";
                        break;
                    case 2:
                        datestring = "Dienstag, den ";
                        break;
                    case 3:
                        datestring = "Mittwoch, den ";
                        break;
                    case 4:
                        datestring = "Donnerstag, den ";
                        break;
                    case 5:
                        datestring = "Freitag, den ";
                        break;
                    case 6:
                        datestring = "Samstag, den ";
                        break;
                }
                var hours = date.getHours();
                var minutes = date.getMinutes();
                if(hours<10){
                   hours = "0"+hours;
                }
                if(minutes<10){
                   minutes = "0"+minutes;
                }
                datestring = datestring+date.getDate()+"."+date.getMonth()+"."+date.getFullYear()+
                        " um "+hours+":"+minutes+" Uhr";
                return datestring;
            },
            /**
             * Handles Reset-Button Click; Resets the priorities-Array and calls childs resetSelection functions
             */
            _handleResetClick: function(e){
                this._fillPrioritiesArray();
                var dateselectors = Polymer.dom(this.root).querySelectorAll("#dateselectors");
                for(i = 0; i < dateselectors.length; i++){
                    dateselectors[i]._resetSelection();
                }
                this.fire("reset-click");
            },

            /**
             * Handle date click from Child (date-creator)
             * Update child priorities-Array
             * @param e - Event Variable
             * @private
             */
            _handleDateClick: function(e){
                e.target.priorities = this.priorities;
            },

            /**
             * Handle priority click from Child (date-creator)
             * @param e - Event Variable
             * @private
             */
            _handlePriorityClick: function(e){
                this.chosenslots[e.target.chosenpriority-1]= e.target.timeslots[e.target.chosenslotindex];
                this.priorities[e.target.chosenpriority-1] = 0;
            },

            /**
             * Handle save click
             * @param e - Event Variable
             * @private
             */
            _handleSaveClick: function(e){
                this.fire("save-click");
            },

            /**
             * Replace a already chosen priority with e newly selected one
             * @param e - Event Variable
             * @private
             */
            _handleReplacePriority: function(e){
                for(i=0; i<this.priorities.length; i++){
                    if(this.chosenslots[i] == e.target.timeslots[e.target.chosenslotindex]){
                        this.chosenslots[i]= '';
                        this.priorities[i] = i+1;
                    }
                }
            }
        });
    </script>
</dom-module>