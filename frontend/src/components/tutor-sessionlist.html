<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">


<dom-module id="tutor-sessionlist">

    <template>

        <style include="shared-styles">
            :host {
                min-width: 320px;
                display: block;
                /*background-color: var(--paper-blue-grey-100);*/
            }
            paper-button {
                width: calc(35% - 20px);
            }
            paper-item {
                cursor: pointer
            }
            .session_date {
                width: 35%;
                min-width: 150px;
            }
            .session_time {
                width: 20%;
            }
            .session_icon {
                width: 5%;
                min-width: 24px;
            }
            .session_type {
                width: 30%;
            }
            .sessions_row {
                border-top: 2px solid var(--paper-grey-200)
            }
            .sessions_row:first-of-type {
                border-top: none
            }
            .sessions_row:hover {
                background-color: var(--paper-grey-100)
            }
            .sessions_heading {
                background-color: var(--paper-blue-grey-800);
                color: white;
                /*box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);*/
            }
            .session_details {
                font-size: 12px;
            }
            paper-listbox {
                padding: 0
            }
            .session-unfolded {
                border-left: 5px solid var(--paper-blue-grey-400);
                font-weight: bold;
            }
            .session_toggleDropdown {
                width: 4%;
                color: var(--paper-blue-grey-200);
            }
            .session-unfolded .session_toggleDropdown {
                transform: rotate(90deg);
                transition: transform .3s;
            }

        </style>

        <api-request
                headers="[[ ajax_labs.headers ]]"
                method="[[ ajax_labs.method ]]"
                endpoint="[[ ajax_labs.endpoint ]]"
                on-api-response="_apiLabsResponse"></api-request>
        <api-request
                headers="[[ ajax_exercises.headers ]]"
                method="[[ ajax_exercises.method ]]"
                endpoint="[[ ajax_exercises.endpoint ]]"
                on-api-response="_apiExercisesResponse"></api-request>
        <api-request
                id="ajax_group"
                headers="[[ ajax_group.headers ]]"
                method="[[ ajax_group.method ]]"
                endpoint="[[ ajax_group.endpoint ]]"
                on-api-response="_apiGroupResponse"></api-request>

        <div class="lab-list-container">
            <template is="dom-if" if="[[ !finishedSessionsLoad ]]">
                <paper-spinner active></paper-spinner>
            </template>
            <template is="dom-if" if="[[ finishedSessionsLoad ]]">
                <paper-listbox>
                    <paper-item on-click="toggleCollapse" class="sessions_heading">
                        <span class="session_toggleDropdown mobile-hidden" style="width: 4%">
                        </span>
                        <span class="session_date">Datum</span>
                        <span class="session_time">Zeit</span>
                        <span class="session_icon" style="width:15%">Typ</span>
                        <span class="session_type"></span>
                    </paper-item>
                    <template  is="dom-repeat" items="[[ sessions ]]" filter="prettySessionEntry">
                        <paper-item on-click="toggleCollapse" class="sessions_row" id="src-[[ item.id ]]">
                                <span class="session_toggleDropdown mobile-hidden">
                                    <iron-icon icon="hardware:keyboard-arrow-right"></iron-icon>
                                </span>
                            <span class="session_date">[[ item.date_string ]]</span>
                            <span class="session_time">[[ item.time_string ]]</span>
                            <span class="session_icon"><iron-icon icon="[[ item.icon ]]"></iron-icon></span>
                            <span class="session_type">[[ item.labType_string ]]</span>
                        </paper-item>
                        <iron-collapse id="collapse-[[ item.id ]]">
                            <paper-item class="session_details" style="border-left: 2px solid var(--paper-blue-grey-500)">
                                [[ item.location ]]
                            </paper-item>
                        </iron-collapse>

                    </template>
                </paper-listbox>
            </template>
        </div>

        <iron-signals on-iron-signal-switchlocale="_switchLocale"></iron-signals>
    </template>
    <script>


        Polymer({
            is: 'tutor-sessionlist',
            properties: {
                accessToken: String,
                language: {
                    type: String,
                    value: 'de'
                },
                selfInfo: String,
                nextSessions: {
                    type: Array,
                    value: []
                },
                users_in_exercises: {
                    type: Array,
                    value: []
                },
                sessions: {
                    type: Array,
                    value: []
                },
                assignedLabs: {
                    type: Array
                },
                labTypeAudio: Object,
                labTypeVideo: Object,
                labTypeFoto: Object,
                labTypesArray: {
                    type: Array,
                    value: []
                },
                finishedSessionsLoad: false
            },

            observers: [
                '_initSessionList(labTypeAudio, labTypeVideo, labTypeFoto, assignedLabs)',
//                '_initSessionList(labTypesArray, assignedLabs)'
            ],

            ready: function () {
//                this.ajax_labs = {
//                    headers: {
//                        Authorization: this.accessToken
//                    },
//                    method: 'GET',
//                    endpoint: '/labs/?filter[where][tutorId]=' + this.selfInfo.id
//                };
//                this.ajax_exercises = {
//                    headers: {
//                        Authorization: this.accessToken
//                    },
//                    method: 'GET',
////                    endpoint: '/exercises/?filter[where][tutor]=' + this.selfInfo.id
//                        endpoint: '/platformusers/' + this.selfInfo.id + '/exercise'
//                };
//                this.ajax_labTypes = {
//                    'headers': {
//                        'Authorization': this.accessToken
//                    },
//                    method: 'GET',
//                    endpoint: '/labTypes/'
//                };
            },

            /**
             * Localization setup
             */
            behaviors: [
                Polymer.AppLocalizeBehavior
            ],
            attached: function() {
                this.loadResources(this.resolveUrl('../shared/locales.json'));
            },
            _switchLocale: function() {
                this.language = (this.language == 'en') ? 'de' : 'en';
            },

            toggleCollapse: function(e) {
                this.$$("#collapse-" + e.model.item.id).toggle();
                this.$$("#src-" + e.model.item.id).classList.toggle('session-unfolded');
            },

            prettySessionEntry: function(item) {
                prettyItem = item

                switch(item.labType_string){
                    case "":
                        prettyItem.icon = "social:school";
                        prettyItem.labType_string = "Ãœbung"
                        break;
                    case "Audio":
                        prettyItem.icon = "av:volume-mute";
                        break;
                    case "Video":
                        prettyItem.icon = "av:videocam";
                        break;
                    case "Foto":
                        prettyItem.icon = "image:photo-camera";
                        break;
                }

                return prettyItem;
            },

            _apiLabsResponse: function(response) {
                this._initSessionList(response.detail)
//                this.futureLabs = this.getOnlyFutureDates(response.detail);
            },
            _apiExercisesResponse: function(response) {
//                this.futureExercises = this.getOnlyFutureDates(response.detail);
                if (response.detail.length == 0)
                    return;
                this._initSessionList(response.detail)
            },

            /**
             * Function to remove objects that have a property 'date' that lies in the past from an array
             * @param array
             * @returns {Array}
             */
            getOnlyFutureDates: function(array) {
                var futureDates = [];
                var today = Date.now();
                for (var i = 0; i < array.length; i++) {
                    var currentSession = array[i];
                    if (new Date(currentSession.date) > today)
                        this.push('nextSessions', new Object({ 'info': currentSession }));
                }
                return futureDates;
            },

            _initSessionList: function(labTypeAudio, labTypeVideo, labTypeFoto, assignedLabs) {

                if (assignedLabs.length == 0)
                    return null;

                this._makeLabTypesArray(labTypeAudio, labTypeVideo, labTypeFoto);

                var labTypesArray = [labTypeAudio, labTypeVideo, labTypeFoto];

                var type = ("labTypeId" in assignedLabs[0]) ? "lab" : "exercise";
                var sessions_list = [];
                console.log("received type: " + type);
                console.log(assignedLabs);

                for (var i = 0; i < assignedLabs.length; i++) {

                    var date = new Date(assignedLabs[i].date);
                    var date_string = this._getDateString(date);
                    var time_string = (date.getHours() + 1) + ":" + (date.getMinutes()<10 ? '0' : '') + date.getMinutes();
                    var labType_string = ""

                    if (labTypesArray.length != 0) {
                        for (var j = 0; j < labTypesArray.length; j++) {
                            if (labTypesArray[j].id == assignedLabs[i].labTypeId)
                                labType_string = labTypesArray[j].type_str
                        }
//                        if (assignedLabs[i].labTypeId in labTypesArray)
//                            labType_string = labTypesArray[assignedLabs[i].labTypeId]
                    }

                    var session = {
                        'id': assignedLabs[i].id,
                        'type': type,
                        'date': assignedLabs[i].date,
                        'date_string': date_string,
                        'time_string': time_string,
                        'location': assignedLabs[i].location,
                        'groupId': assignedLabs[i].groupId,
                        'labTypeId': assignedLabs[i].labTypeId,
                        'labType_string': labType_string,
                        'exercise_name': assignedLabs[i].name
                    };

                    this.push('sessions', session);
                    this.$.ajax_group.$.request.auto = false;

                    // If a group signed up for the session, get their data
//                    if (typeof assignedLabs[i].groupId != 'undefined') {
//                        this.ajax_group = {
//                            'headers': {
//                                'Authorization': this.accessToken
//                            },
//                            'method': 'GET',
//                            'endpoint': '/labs/' + assignedLabs[i].id + '/group'
//                        }
//                        this.$.ajax_group.$.request.generateRequest();
//                    }
                }
            },

            _apiGroupResponse: function(response) {
                console.log(response.detail)
            },

            _makeLabTypesArray: function(labtypeAudio, labtypeVideo, labtypeFoto) {
//                console.log(response.detail)
                var labtypes = [ labtypeAudio, labtypeVideo, labtypeFoto ];

                for (var i = 0; i < labtypes.length; i++) {
                    this.labTypesArray[labtypes[i].type_str] =  {
                        'id':  labtypes[i].id,
                        'name': labtypes[i].type_str,
                        'registration_open': labtypes[i].registration_open
                    }

                    if (this.sessions.length != 0) {
                        var labType_string;
                        for (var j = 0; j < this.sessions.length; j++) {
                            if (labtypes[i].id == this.sessions[j].labTypeId) {
                                this.sessions[j].labType_string = labtypes[i].type_str
                            }
                        }
//                        this.notifyPath('sessions.name');
//                        var sessions = this.sessions;
//                        this.sessions = []
//                        this.sessions = sessions;

                        var sessions = this.sessions;
                        this.set('sessions', []);
                        this.set('sessions', sessions);
                    }
                }

                this.finishedSessionsLoad = true
                return this.labTypesArray;
            },

            /**
             * Creates string from the given date
             * @param {String} date - date that will be transformed to String
             */
            _getDateString: function(date){
                var datestring = "";
                switch(date.getDay()){

                    case 0:
                        datestring = "Sonntag, ";
                        break;
                    case 1:
                        datestring = "Montag, ";
                        break;
                    case 2:
                        datestring = "Dienstag, ";
                        break;
                    case 3:
                        datestring = "Mittwoch, ";
                        break;
                    case 4:
                        datestring = "Donnerstag, ";
                        break;
                    case 5:
                        datestring = "Freitag, ";
                        break;
                    case 6:
                        datestring = "Samstag, ";
                        break;
                }
                datestring = datestring+date.getDate()+"."+ (date.getMonth()+1) + "."+date.getFullYear();
                return datestring;
            },
        });
    </script>
</dom-module>