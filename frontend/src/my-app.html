<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="components/index-card.html">
<link rel="import" href="components/group-card.html">
<link rel="import" href="components/navigation-bar.html">
<link rel="import" href="components/notifications-card.html">
<link rel="import" href="services/api-request.html">
<link rel="import" href="shared/shared-styles.html">

<link rel="import" href="views/login-view.html">
<link rel="import" href="views/main-view.html">
<link rel="import" href="views/error-view.html">

<dom-module id="my-app">
    <template>
        <style include="shared-styles">
        </style>


        <!-- Fetches info about currently logged in user -->
        <api-request
                headers="[[ ajax.headers ]]"
                method="[[ ajax.method ]]"
                endpoint="[[ ajax.endpoint ]]"
                on-api-response="_handleUserResponse"
                on-api-error="_handleUserError" loading="{{isLoading}}" ></api-request>

        <!--Logout Request-->
        <api-request
                headers="[[ ajaxLogout.headers ]]"
                method="[[ ajaxLogout.method ]]"
                endpoint="[[ ajaxLogout.endpoint ]]"
                on-api-response="_handleLogoutResponse"></api-request>

        <!--App Location Binds to the Apps URL-->
        <app-location route="{{route}}" use-hash-as-path></app-location>

        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"
                tail="{{subroute}}"></app-route>


        <!-- P A G E S -->
        <iron-pages
                selected="[[routeData.page]]"
                attr-for-selected="name"
                fallback-selection="error">
            <main-view
                    name="main"
                    access-token="{{ session.accessToken }}"
                    user="{{user}}"
                    logged-in="{{ session.loggedIn }}"
                    user-id="{{ session.userId }}"
                    show-notifications="{{ showDesktopNotifications }}"
                    route="{{subroute}}"></main-view>
            <login-view
                    name="login"
                    access-token="{{ session.accessToken }}"
                    logged-in="{{ session.loggedIn }}"
                    user-id="{{ session.userId }}"
                    route="{{ subroute }}"></login-view>
            <error-view name="error"></error-view>

        </iron-pages>

        <!--/app-header-layout>

      </app-drawer-layout-->

    </template>

    <script>
        Polymer({
            is: 'my-app',

            properties: {
                /*page: {
                 type: String,
                 reflectToAttribute: false,
                 observer: '_pageChanged'
                 },*/
                route: {
                    type: Object,
                    notify: true,
                    observer: '_routeChanged'
                },
                subroute: {
                    type: Object,
                    notify: true
                },
                routeData: {
                    type: Object,
                    observer: '_routeDataChanged'
                },
                session: {
                    type: Object,
                    value: {
                        accessToken: null,
                        loggedIn: false,
                        userId: null
                    }
                },
                user: {
                    type: Object
                }
            },

            listeners: {
                'USER_LOGOUT': '_fireLogoutRequest',
                'USER_LOGIN': '_handleLogin'
            },


            ready: function () {

                // Check for valid session cookies
                var cookieAccessToken = this._getCookie('mt-api-accesstoken');
                var cookieUserId = this._getCookie('mt-api-userid');

                if (cookieAccessToken !== '' && cookieUserId !== '') {

                    this.set('session.accessToken', cookieAccessToken);
                    this.set('session.userId', cookieUserId);

                    //Fire User Request to verify Cooke Credentials
                    this.ajax = {
                        headers: {
                            Authorization: ''//this.session.accessToken
                        },
                        method: 'GET',
                        endpoint: '/platformusers/' + this.session.userId
                    };
                } else {

                    //TODO Route to login without use of _routeChanged

                    //Reset Cookies, if parts left
                    document.cookie = 'mt-api-accesstoken=; expires=Thu, 01 Jan 1970 00:00:00 UTC';
                    document.cookie = 'mt-api-userid=; expires=Thu, 01 Jan 1970 00:00:00 UTC';
                }

            },

            /**
             * Helper function for parsing document.cookie
             * @param {String} cookieName - key of the cookie whose value should be returned
             * @returns {String} Cookie value
             * @private
             */
            _getCookie: function (cookieName) {

                var name = cookieName + '=';
                var allCookies = document.cookie.split(';');
                var idx;
                for (idx in allCookies) {
                    var cookie = allCookies[idx];
                    while (cookie.charAt(0) == ' ') {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(name) == 0) {
                        return cookie.substring(name.length, cookie.length);
                    }
                }
                return '';

            },

            /**
             * Callback fired when the applications route changes
             * @param {String} page - new value of routeData.page
             * @private
             */
            _routePageChanged: function (page) {

                //this.page = page || 'main';

                // check if mobile or desktop notifications are needed
                var screenwidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                if (screenwidth > 1023) {
                    this.showDesktopNotifications = true;
                    this.showMobileNotifications = false;
                }
                else {
                    this.showDesktopNotifications = false;
                }
            },

            /**
             * Callback fired on API response to Platform User request
             * @param {Object} response - response to API request
             * @private
             */
            _handleUserResponse: function (response) {
                console.log(response);
                this.set('user', response.detail);
                this.set('route.path', '/main');
                this.set('routeData.page', 'main');
                this.set('session.loggedIn', true);
                console.log(this.user);

            },

            _handleUserError: function (response) {
                console.log(response);
                this.set('route.path', '/login');
                this.set('routeData.page', 'login');

                //Reset Cookies, if parts left
                document.cookie = 'mt-api-accesstoken=; expires=Thu, 01 Jan 1970 00:00:00 UTC';
                document.cookie = 'mt-api-userid=; expires=Thu, 01 Jan 1970 00:00:00 UTC';
            },

            _routeChanged: function (detail) {
                console.log(detail);
                if (!this.session.loggedIn & !this.isLoading ) {
                    console.log("Not Logged In!");
                    this.set('route.path', '/login');
                }
            },

            _routeDataChanged: function (detail) {
                console.log(detail);
            },


            /**
             * Callback fired when logout button is pressed. Sets a property
             * `ajax` containing information for logout API call
             * @private
             */
            _fireLogoutRequest: function () {
                console.log("Heard Log Out Firing");

                if (this.session.loggedIn) {
                    this.ajaxLogout = {
                        headers: {
                            'Authorization': this.session.accessToken
                        },
                        method: 'POST',
                        endpoint: '/platformusers/logout'
                    }
                }
            },

            _handleLogoutResponse: function (event) {

                console.log("LogOut Success");
                document.cookie = 'mt-api-accesstoken=; expires=Thu, 01 Jan 1970 00:00:00 UTC';
                document.cookie = 'mt-api-userid=; expires=Thu, 01 Jan 1970 00:00:00 UTC';

                this.set('accessToken', '');
                this.set('userId', '');
                this.set('loggedIn', false);
                this.set('user', {});
                this.set('group', {});
                this.set('route.path', '/login');
                this.set('routeData.page', 'login');
            },


            _handleLogin: function (event) {
                this.ajax = {
                    headers: {
                        Authorization: event.detail.id
                    },
                    method: 'GET',
                    endpoint: '/platformusers/' + event.detail.userId
                };
            }

        });
    </script>
</dom-module>
